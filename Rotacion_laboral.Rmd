---
title: "Rotacion Laboral"
author: "Hugo Sanchez Lozada"
date: "2025-07-15"
output: html_document
---
### 1. Cargar librerías

```{r, message=FALSE}
# ============================
# 1. Cargar librerías
# ============================

library(tidyverse)    
library(lubridate)    
library(scales)       



```
### 2. Cargar archivos CSV

```{r, message=FALSE}
# ============================
# 2. Cargar archivos CSV
# ============================

employee      <- read_csv("C:\\Users\\Lenovo\\Documents\\R\\Rotacion-Laboral\\Employee.csv")
education     <- read_csv("C:\\Users\\Lenovo\\Documents\\R\\Rotacion-Laboral\\EducationLevel.csv")
performance   <- read_csv("C:\\Users\\Lenovo\\Documents\\R\\Rotacion-Laboral\\PerformanceRating.csv")
rating        <- read_csv("C:\\Users\\Lenovo\\Documents\\R\\Rotacion-Laboral\\RatingLevel.csv")
satisfaction  <- read_csv("C:\\Users\\Lenovo\\Documents\\R\\Rotacion-Laboral\\SatisfiedLevel.csv")
```
### 3. Limpiar datos

```{r, message=FALSE}
# ============================
# 3. Limpiar datos
# ============================

# Calcula los duplicados

duplicados <- duplicated(employee$EmployeeID)
sum(duplicados)  # cuántos hay

# Calcula la cantidad de valores faltantes (NA) en cada columna
colSums(is.na(employee))

colSums(is.na(performance))

names(employee)

# Columnas eliminadas y razones:
# "FirstName", "LastName" → Identificadores personales, no influyen en análisis.
# "StockOptionLevel" → A menudo tiene valores repetidos y poco interpretables sin contexto.
# "BusinessTravel" → A menos que se muestre que tiene un efecto significativo en atrición, se puede considerar irrelevante.


employee <- employee |>
  select(
    EmployeeID, Gender, Age, Department, `DistanceFromHome (KM)`,
    Ethnicity, Education, EducationField, JobRole, State, MaritalStatus, 
    Salary, OverTime, Attrition, HireDate, YearsAtCompany,
    YearsInMostRecentRole, YearsSinceLastPromotion,
    YearsWithCurrManager
  ) |>
  rename(DistanceFromHomeKM = `DistanceFromHome (KM)`)

# Para el df performance no se eliminaron columnas ya que son relevantes para el analisis.
```
### 4. Resumir datos de performance

```{r, message=FALSE}
# ============================
# 4. Resumir datos de performance
# ============================

# La tabla performance contiene múltiples evaluaciones por empleado. 
# Para poder integrar esta información con los datos (employee), es 
# necesario reducirla a un solo registro por empleado promediando.


# Promedia registros y guarda versión redondeada.
resumen_perf <- performance |>
  group_by(EmployeeID) |>
  summarise(
    # Valores redondeados (para etiquetado y clasificación)
    avg_EnvSatisfaction     = round(mean(EnvironmentSatisfaction, na.rm = TRUE)),
    avg_JobSatisfaction     = round(mean(JobSatisfaction, na.rm = TRUE)),
    avg_RelSatisfaction     = round(mean(RelationshipSatisfaction, na.rm = TRUE)),
    avg_SelfRating          = round(mean(SelfRating, na.rm = TRUE)),
    avg_ManagerRating       = round(mean(ManagerRating, na.rm = TRUE)),
    avg_WorkLifeBalance     = round(mean(WorkLifeBalance, na.rm = TRUE)),
    
    # Otros cálculos
    total_Trainings         = sum(TrainingOpportunitiesTaken, na.rm = TRUE),
    total_Opportunities     = sum(TrainingOpportunitiesWithinYear, na.rm = TRUE),
    last_ReviewDate         = max(as.Date(ReviewDate, format = "%m/%d/%Y")),
    eval_count              = n() # conteo de evaluaciones.
  )
# "HireDate" + "YearsAtCompany", nos dara la ultima fecha en la compañia, 
# se peude obtener la frecuencia de Attrition (rotacion) anual.
# Convertir la columna HireDate a formato de fecha y extraer el año.

employee <- employee |>
  mutate(
    HireYear = year(HireDate),
    LastYearAtCompany = HireYear  + YearsAtCompany
  )

# Para hacer analisis de evaluaciones de desempeño por año,
# Convertir la columna ReviewDate a formato de fecha y extraer el año.

performance <- performance |>
  mutate(
    ReviewDate = mdy(ReviewDate),
    Year = year(ReviewDate)
  )
```
### 5. Unir los datos

```{r, message=FALSE}
# ============================
# 5. Unir los datos
# ============================

# Renombrar columnas de education
colnames(education)[1] <- "EducationLevelID"

# Join education
employee <- left_join(employee, education, by = c("Education" = "EducationLevelID"))

# Unir con resumen de performance, usa inner join para evitar NA en registros (estos se considera para el analisis) 
datos <- inner_join(employee, resumen_perf, by = "EmployeeID")

# Renombrar columna de rating para join
colnames(rating)[1] <- "RatingID"

# Unir etiquetas de SelfRating
rating_self <- rating
colnames(rating_self) <- c("avg_SelfRating", "SelfRatingLabel")
datos <- left_join(datos, rating_self, by = "avg_SelfRating")

# Unir etiquetas de ManagerRating
rating_manager <- rating
colnames(rating_manager) <- c("avg_ManagerRating", "ManagerRatingLabel")
datos <- left_join(datos, rating_manager, by = "avg_ManagerRating")

# Unir etiquetas de satisfacción
satisfaction_env <- satisfaction
colnames(satisfaction_env) <- c("avg_EnvSatisfaction", "EnvironmentSatisfactionLabel")
datos <- left_join(datos, satisfaction_env, by = "avg_EnvSatisfaction")

satisfaction_job <- satisfaction
colnames(satisfaction_job) <- c("avg_JobSatisfaction", "JobSatisfactionLabel")
datos <- left_join(datos, satisfaction_job, by = "avg_JobSatisfaction")

satisfaction_rel <- satisfaction
colnames(satisfaction_rel) <- c("avg_RelSatisfaction", "RelationshipSatisfactionLabel")
datos <- left_join(datos, satisfaction_rel, by = "avg_RelSatisfaction")

satisfaction_bal <- satisfaction
colnames(satisfaction_bal) <- c("avg_WorkLifeBalance", "WorkLifeBalanceLabel")
datos <- left_join(datos, satisfaction_bal, by = "avg_WorkLifeBalance")
```
### 6. Análisis preliminar

```{r, message=FALSE}
# ============================
# 6. Análisis preliminar
# ============================

# Visualiza una muestra compacta de las variables y tipos de datos del dataframe para asegurarte de que todo esté en orden
glimpse(datos)

# Resume estadísticamente cada variable: mínimos, máximos, medias, etc.
summary(datos)



# ============================
# Se utiliza el df performance sin resumir para hacer un analisis por año
# ============================


# ============================
# Promedio de satisfaccion por año 
# ============================

# Datos resumidos por año y variable
satisfaccion_anual <- performance |>
  group_by(Year) |>
  summarise(
    JobSatisfaction = mean(JobSatisfaction, na.rm = TRUE),
    EnvironmentSatisfaction = mean(EnvironmentSatisfaction, na.rm = TRUE),
    RelationshipSatisfaction = mean(RelationshipSatisfaction, na.rm = TRUE),
    WorkLifeBalance = mean(WorkLifeBalance, na.rm = TRUE)
  ) |>
  pivot_longer(-Year, names_to = "Variable", values_to = "Average")

# Gráfico con línea de tendencia general (ajuste lineal)
grafico_satisfaction <- ggplot(satisfaccion_anual, aes(x = Year, y = Average, color = Variable)) +
  geom_line(linewidth  = 1.5) +
  geom_point(size = 3) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "#B22222", linewidth  = 3) +
  scale_x_continuous(breaks = sort(unique(satisfaccion_anual$Year))) +
  scale_y_continuous(
    limits = c(3, 5),
    breaks = satisfaction$SatisfactionID[3:5] ,
    labels = satisfaction$SatisfactionLevel[3:5]  
  ) +
  labs(
    title = "Annual Satisfaction Indicators\n(withlinear trend)",
    x = NULL,     # Oculta el título del eje X
    y = NULL,     # Oculta el título del eje Y
    color = NULL  # Oculta el título de la leyenda
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 22),
    axis.text.y = element_text(angle = 45, hjust = 1, size = 22),
    legend.position = "bottom",
    legend.title = element_text(size = 16, face = "bold"),
    legend.text = element_text(size = 18),
    plot.title = element_text(size = 18, face = "bold"),
    panel.grid.major = element_blank(),  # elimina cuadrícula mayor
    panel.grid.minor = element_blank()   # elimina cuadrícula menor
  )

# Mostrar gráfico
print(grafico_satisfaction)

ggsave("satisfaction_trend_highres.png", plot = grafico_satisfaction, width = 12, height = 8, dpi = 400)


# ============================
# Promedio de ratings por año
# ============================

# Datos resumidos por año y variable

rating_anual <- performance |>
  group_by(Year) |>
  summarise(
    SelfRating     = mean(SelfRating, na.rm = TRUE),
    ManagerRating  = mean(ManagerRating, na.rm = TRUE)
  ) |>
  pivot_longer(cols = -Year, names_to = "Variable", values_to = "Average")

# Gráfico con línea de tendencia general (ajuste lineal)

grafico_rating <- ggplot(rating_anual, aes(x = Year, y = Average, color = Variable)) +
  geom_line(linewidth  = 1.5) +
  geom_point(size = 3) +
  #geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "#008080", linewidth  = 3) +
  scale_x_continuous(breaks = sort(unique(rating_anual$Year))) +
  scale_y_continuous(
    limits = c(2, 5),
    breaks = rating$RatingID[2:5],
    labels = rating$RatingLevel[2:5]
  ) +
  labs(
    title = "Annual Average Self and Manager Rating",
    x = NULL,     # Oculta el título del eje X
    y = NULL,     # Oculta el título del eje Y
    color = NULL  # Oculta el título de la leyenda
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
    axis.text.y = element_text(angle = 45, hjust = 1, size = 16),
    legend.position = "bottom",
    legend.title = element_text(size = 16, face = "bold"),
    legend.text = element_text(size = 14),
    plot.title = element_text(size = 18, face = "bold"),
    panel.grid.major = element_blank(),  # elimina cuadrícula mayor
    panel.grid.minor = element_blank()   # elimina cuadrícula menor
  )

# Mostrar gráfico
print(grafico_rating)

# Guardar imagen
ggsave("rating_trend_highres.png", plot = grafico_rating, width = 12, height = 8, dpi = 400)


# ============================
# Promedio de oportunidades por año
# ============================

training_anual <- performance |>
  group_by(Year) |>
  summarise(
    TrainingsTaken = mean(TrainingOpportunitiesWithinYear, na.rm = TRUE),
    Opportunities  = mean(TrainingOpportunitiesTaken, na.rm = TRUE)
  ) |>
  pivot_longer(cols = -Year, names_to = "Variable", values_to = "Average")

# ============================
# Gráfico
# ============================

grafico_training <- ggplot(training_anual, aes(x = Year, y = Average, color = Variable)) +
  geom_line(linewidth  = 1.5) +
  geom_point(size = 3) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "#DAA520", linewidth  = 3) +
  scale_x_continuous(breaks = sort(unique(training_anual$Year))) +
  labs(
    title = "Annual Evolution of Training Opportunities",
    x = NULL,     # Oculta el título del eje X
    y = NULL,     # Oculta el título del eje Y
    color = NULL  # Oculta el título de la leyenda
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
    axis.text.y = element_text(angle = 45, hjust = 1, size = 16),
    legend.position = "bottom",
    legend.title = element_text(size = 16, face = "bold"),
    legend.text = element_text(size = 14),
    plot.title = element_text(size = 18, face = "bold"),
    panel.grid.major = element_blank(),  # elimina cuadrícula mayor
    panel.grid.minor = element_blank()   # elimina cuadrícula menor
  )

# Mostrar gráfico
print(grafico_training)

# Guardar imagen
ggsave("training_trend_highres.png", plot = grafico_training, width = 12, height = 8, dpi = 400, bg = "white")



# ============================
# Attriction por año
# ============================

attrition_anual <- employee |>
  group_by(LastYearAtCompany) |>
  summarise(
    AttritionAnual = sum(Attrition == "Yes", na.rm = TRUE)
  ) |>
  pivot_longer(cols = -LastYearAtCompany, names_to = "Variable", values_to = "cont")

# ============================
# Gráfico
# ============================

grafico_attriction_anual <- ggplot(attrition_anual, aes(x = LastYearAtCompany, y = cont, color = Variable)) +
  geom_line(linewidth  = 1.5) +
  geom_point(size = 3) +
  #geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "#A3222B", linewidth  = 3) +
  scale_x_continuous(breaks = sort(unique(attrition_anual$LastYearAtCompany))) +
  labs(
    title = "Annual Number of Attrition",
    x = NULL,     # Oculta el título del eje X
    y = NULL,     # Oculta el título del eje Y
    color = NULL  # Oculta el título de la leyenda
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 22),
    axis.text.y = element_text(angle = 45, hjust = 1, size = 22),
    legend.position = "bottom",
    legend.title = element_text(size = 16, face = "bold"),
    legend.text = element_text(size = 22),
    plot.title = element_text(size = 18, face = "bold"),
    panel.grid.major = element_blank(),  # elimina cuadrícula mayor
    panel.grid.minor = element_blank()   # elimina cuadrícula menor
  )

# Mostrar gráfico
print(grafico_attriction_anual)

# Guardar imagen
ggsave("attriction_anual.png", plot = grafico_attriction_anual, width = 12, height = 8, dpi = 400)




# ============================
# Hire por año
# ============================

hire_anual <- employee |>
  group_by(HireYear) |>
  summarise(
    Hire  = n_distinct(EmployeeID)
  ) |>
  pivot_longer(cols = -HireYear, names_to = "Variable", values_to = "cont")

# ============================
# Gráfico
# ============================

grafico_hire_anual <- ggplot(hire_anual, aes(x = HireYear, y = cont, color = Variable)) +
  geom_line(linewidth  = 1.5) +
  geom_point(size = 3) +
  #geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "#DAB921", size = 3) +
  scale_x_continuous(breaks = sort(unique(hire_anual$HireYear))) +
  labs(
    title = "Annual Number of Hire",
    x = NULL,     # Oculta el título del eje X
    y = NULL,     # Oculta el título del eje Y
    color = NULL  # Oculta el título de la leyenda
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
    axis.text.y = element_text(angle = 45, hjust = 1, size = 16),
    legend.position = "bottom",
    legend.title = element_text(size = 16, face = "bold"),
    legend.text = element_text(size = 14),
    plot.title = element_text(size = 18, face = "bold"),
    panel.grid.major = element_blank(),  # elimina cuadrícula mayor
    panel.grid.minor = element_blank()   # elimina cuadrícula menor
  )

# Mostrar gráfico
print(grafico_hire_anual)
```
### 7. Visualizaciones

```{r, message=FALSE}
# ============================
# 7. Visualizaciones
# ============================


# ============================
# Se utiliza el df employee solamnete para analizar atrición para buscar grupos vulnerables y tendencias
# ============================


# Crear rangos salariales personalizados
employee <- employee |>
  mutate(SalaryRange = cut(
    Salary,
    breaks = seq(0, 550000, by = 50000),
    include.lowest = TRUE,
    right = FALSE,
    labels = paste0(
      "$", format(seq(0, 500000, by = 50000), big.mark = ","),
      " - $", format(seq(50000, 550000, by = 50000) - 1, big.mark = ",")
    )
  ))


# Crear grupos de Edad
employee <- employee |>
  mutate(AgeGroup = cut(Age, 
                        breaks = c(18, 25, 35, 45, 55), 
                        labels = c("18-25", "26-35", "36-45", "46-55"),
                        right = TRUE,
                        include.lowest = TRUE))

# Crear grupos de Distancia
employee <- employee |>
  mutate(DistanceGroup = cut(
    DistanceFromHomeKM, 
    breaks = c(0, 5, 10, 20, 30, 40, Inf),
    labels = c("0-5 km", "6-10 km", "11-20 km", "21-30 km", "31-40 km", "41+ km"),
    right = TRUE,
    include.lowest = TRUE
  ))


# Crear funcion de Grafica

crear_grafico_attrition <- function(df, variable, titulo, x_label, y_label = "Attrition Proportion", df_aux = NULL, orden = NULL) {
  
  # Asegurarse de que Attrition tenga niveles completos
  df <- df |> mutate(Attrition = factor(Attrition, levels = c("Yes", "No")))
  
  # Calcular cantidades y proporciones, asegurando combinaciones completas
  resumen <- df |>
    group_by(across(all_of(variable)), Attrition) |>
    summarise(Cantidad = n(), .groups = "drop") |>
    complete(Attrition, nesting(!!sym(variable)), fill = list(Cantidad = 0)) |>
    group_by(across(all_of(variable))) |>
    mutate(Proporcion = Cantidad / sum(Cantidad)) |>
    ungroup() |>
    mutate(!!variable := as.character(!!sym(variable)))
  
  # Crear gráfico con colores difuminados y proporciones
  grafico <- ggplot(resumen, aes(x = !!sym(variable), y = Proporcion, fill = Attrition)) +
    geom_bar(stat = "identity", position = position_dodge(preserve = "single"), 
             color = "black", alpha = 0.4) +
    labs(
      title = titulo,
      x = NULL,
      y = NULL,
      fill = "Attrition?"
    ) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_fill_manual(values = c("Yes" = "#EC3AA8", "No" = "#A3E635")) +
    theme_minimal(base_size = 15) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
      axis.text.y = element_text(size = 22),
      plot.title = element_text(face = "bold", size = 18),
      legend.title = element_text(face = "bold"),
      panel.grid = element_blank()
    )
  
  # Aplicar orden de las etiquetas en x
  if (!is.null(df_aux) && !is.null(orden)) {
    grafico <- grafico +
      scale_x_discrete(limits = df_aux[[orden]])
  }
  
  return(grafico)
}

# Gráficos de atrición:

# By State
print(crear_grafico_attrition(employee, "State", 
                              "Attrition Proportion by State", 
                              "State"))
# By MaritalStatus
print(crear_grafico_attrition(employee, "MaritalStatus", 
                              "Attrition Proportion by MaritalStatus", 
                              "MaritalStatus"))

# By salary range
grafico_salary <- crear_grafico_attrition(employee, 
                                          "SalaryRange", 
                                          "Attrition Proportion by Salary Range", 
                                          "Monthly Salary Range")
print(grafico_salary)


# Guardar
ggsave("attrition_by_salary_range.png", plot = grafico_salary, width = 12, height = 8, dpi = 400)


# By Education Level
print(crear_grafico_attrition(employee, "EducationLevel", 
                              "Attrition Proportion by Education Level", 
                              "Nivel educativo", df_aux = education, 
                              orden = "EducationLevel"))

# By Age
grafico_age <- crear_grafico_attrition(employee, 
                                       "AgeGroup", 
                                       "Attrition Proportion by Age Group", 
                                       "Age Group")

print(grafico_age)

# Guardar
ggsave("attrition_by_age_group.png", plot = grafico_age, width = 12, height = 8, dpi = 400)

# By Department
grafico_department <- crear_grafico_attrition(employee, 
                                              "Department", 
                                              "Attrition Proportion by Department", 
                                              "Department")

print(grafico_department)

# Guardar 
ggsave("attrition_by_department.png", plot = grafico_department, width = 12, height = 8, dpi = 400)

# By Education Field
grafico_edu_field <- crear_grafico_attrition(employee, 
                                             "EducationField", 
                                             "Attrition Proportion by Education Field", 
                                             "Education Field")
print(grafico_edu_field)

# Guardar 
ggsave("attrition_by_education_field.png", plot = grafico_edu_field, width = 12, height = 8, dpi = 400)

# By JobRole
grafico_jobrole <- crear_grafico_attrition(employee, 
                                           "JobRole", 
                                           "Attrition Proportion by Job Role", 
                                           "Job Role")
print(grafico_jobrole)

# Guardar 
ggsave("attrition_by_job_role.png", plot = grafico_jobrole, width = 12, height = 8, dpi = 400)

# By Distance
print(crear_grafico_attrition(employee, "DistanceGroup", 
                              "Attrition Proportion by Distance to Work", 
                              "Distance to Work (km)"))

# By Ethnicity
print(crear_grafico_attrition(employee, "Ethnicity", 
                              "Attrition Proportion by Ethnicity", 
                              "Ethnicity"))

# By Gender
print(crear_grafico_attrition(employee, "Gender", 
                              "Attrition Proportion by Gender", 
                              "Gender"))

# By OverTime
# Crear gráfico de atrición por horas extra
grafico_overtime <- crear_grafico_attrition(employee, 
                                            "OverTime", 
                                            "Attrition Proportion by Overtime", 
                                            "Overtime")
print(grafico_overtime)

# Guardar 
ggsave("attrition_by_overtime.png", plot = grafico_overtime, width = 12, height = 8, dpi = 400)

years_order <- data.frame(
  Years = as.character(0:10)
)

# By Years at Company
grafico_years_company <- crear_grafico_attrition(employee, 
                                                 "YearsAtCompany", 
                                                 "Attrition Proportion by Years at Company", 
                                                 "Years at Company", 
                                                 df_aux = years_order, 
                                                 orden = "Years")
print(grafico_years_company)

# Guardar 
ggsave("attrition_by_years_at_company.png", plot = grafico_years_company, width = 12, height = 8, dpi = 400)

# Years Since Last Promotion
print(crear_grafico_attrition(employee, "YearsSinceLastPromotion", 
                              "Attrition Proportion by Years Since Last Promotion", 
                              "Years Since Last Promotion", 
                              df_aux = years_order, 
                              orden = "Years"))

# ============================
# Se utiliza el df "datos" que contiene atrición y satisfaccion para un analisis mas profundo  
# ============================


# Attrition Proportion by Job Satisfaction
print(crear_grafico_attrition(datos, "JobSatisfactionLabel", 
                              "Attrition Proportion by Job Satisfaction", 
                              "Satisfaction Level", 
                              df_aux = satisfaction, 
                              orden = "SatisfactionLevel"))

# Attrition Proportion by Environment Satisfaction
print(crear_grafico_attrition(datos, "EnvironmentSatisfactionLabel", 
                              "Attrition Proportion by Environment Satisfaction", 
                              "Environment Satisfaction Level", 
                              df_aux = satisfaction, 
                              orden = "SatisfactionLevel"))

# Attrition Proportion by Relationship Satisfaction
print(crear_grafico_attrition(datos, "RelationshipSatisfactionLabel", 
                              "Attrition Proportion by Relationship Satisfaction", 
                              "Relationship Satisfaction Level", 
                              df_aux = satisfaction, 
                              orden = "SatisfactionLevel"))

# Attrition Proportion by Work-Life Balance Satisfaction
print(crear_grafico_attrition(datos, "WorkLifeBalanceLabel", 
                              "Attrition Proportion by Work-Life Balance Satisfaction", 
                              "Work-Life Balance Satisfaction Level", 
                              df_aux = satisfaction, 
                              orden = "SatisfactionLevel"))

# Attrition Proportion by Self Performance Rating
print(crear_grafico_attrition(datos, "SelfRatingLabel", 
                              "Attrition Proportion by Self Performance Rating", 
                              "Self-Rating Level", 
                              df_aux = rating, 
                              orden = "RatingLevel"))

# Attrition Proportion by Manager Performance Rating
print(crear_grafico_attrition(datos, "ManagerRatingLabel", 
                              "Attrition Proportion by Manager Performance Rating", 
                              "Manager Rating Level", 
                              df_aux = rating, 
                              orden = "RatingLevel"))
```
### 8. Estadística inferencial

```{r, message=FALSE}
# ============================
# 8. Estadística inferencial
# ============================

# Prueba chi-cuadrado entre la rotación (Attrition) y si hace horas extra (OverTime)
# Evalúa si existe una asociación significativa entre renuncia y horas extra
print(chisq.test(table(datos$Attrition, datos$OverTime)))

# Prueba chi-cuadrado entre la rotación (Attrition) y satisfacción laboral promedio (agrupada)
# Se usa si avg_JobSatisfaction es categórica (por ejemplo: Baja, Media, Alta)
print(chisq.test(table(datos$Attrition, datos$avg_JobSatisfaction)))

# Prueba t de Student para comparar salarios entre empleados que renunciaron y los que no
# Evalúa si hay diferencia significativa en el salario promedio según attrition
print(t.test(Salary ~ Attrition, data = datos))

# Prueba t para comparar los años en la empresa según si hubo rotación
# Para ver si quienes renuncian tienden a quedarse menos tiempo en la empresa
print(t.test(YearsAtCompany ~ Attrition, data = datos))
```
### 9. Regresión logística

```{r, message=FALSE}
# ============================
# 9. Regresión logística
# ============================

# Creamos un modelo de regresión logística binaria
# para predecir la probabilidad de que un empleado renuncie (Attrition = 1)
# en función de:
# - Satisfacción promedio en el trabajo (avg_JobSatisfaction)
# - Si realiza horas extra (OverTime)
# - Su salario (Salary)
# - Antigüedad en la empresa (YearsAtCompany)

datos$Attrition <- ifelse(datos$Attrition == "Yes", 1, 0)
modelo <- glm(Attrition ~ avg_JobSatisfaction + OverTime + Salary + YearsAtCompany,
              data = datos, family = "binomial")
summary(modelo)
```
### 10. Salario vs Satisfacción

```{r, message=FALSE}
# ============================
# 10. Salario vs Satisfacción
# ============================

# ------------------------------------------------------------
# Gráfico: Relación entre salario y permanencia laboral
#
# 
#   Este gráfico muestra cómo varía el tiempo en la compañia en función del salario en la empresa.
#
#   - La línea roja (geom_smooth con método "lm") indica la tendencia
#     general.
#     Es una recta de regresión lineal con banda de confianza (en rosa).
#
# 
#   - Si la línea sube: empleados con mayor salario tienden a permanecer en sus empleos
#   - Si la línea baja: mayor salario se asocia a mayor rotation.
#   - Si la línea es plana: no hay relación clara entre ambas variables.
#   - La dispersión de puntos permite ver cuánta variabilidad hay.
#

ggplot(employee, aes(x = Salary, y = YearsAtCompany)) +
  geom_jitter(width = 5000, height = 0.1, alpha = 0.3, color = "#1f77b4") +
  geom_smooth(method = "lm", se = TRUE, color = "#d62728", fill = "#ffcccc") +
  scale_x_continuous(
    labels = scales::comma_format(),       # etiquetas con coma de miles
    breaks = seq(0, 550000, by = 50000)    # breaks cada 50,000
  ) +
  scale_y_continuous(breaks = 0:10, limits = c(0, 10)) +
  labs(
    title = "Relationship Between Salary (MXN) and years with the company",
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(color = "gray40"),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 14,angle = 45, hjust = 1),
    axis.text.y = element_text(size = 14)   
  )


ggsave("Permanencia_vs_salario.png", width = 10, height = 6, dpi = 300)

```

## Análisis de Estadística Inferencial sobre la Rotación de Personal

Para explorar las posibles causas asociadas con la **(`Attrition`)**, se realizaron pruebas estadísticas inferenciales con el objetivo de evaluar si existen diferencias significativas en distintas variables laborales.

---

### 1. Asociación entre rotación y horas extra (`OverTime`)

Se aplicó una prueba de chi-cuadrado para evaluar si existe una relación significativa entre la rotación y horas extra.

- **Resultado**:  
  `X² = 83.40`, gl = 1, **p-value < 2.2e-16**

- **Interpretación**:  
  Existe una **asociación altamente significativa** entre la rotación y las horas extra. Los empleados que hacen horas extra tienen una **mayor probabilidad de abandonar la empresa** en comparación con quienes no las hacen.

---

### 2. Asociación entre rotación y satisfacción laboral promedio (`avg_JobSatisfaction`)

Se utilizó otra prueba de chi-cuadrado para analizar la relación entre la rotación y los niveles de satisfacción laboral promedio.

- **Resultado**:  
  `X² = 45.44`, gl = 4, **p-value = 3.22e-09**  
  *Advertencia: la aproximación de chi-cuadrado puede ser incorrecta por frecuencias bajas en algunas celdas.*

- **Interpretación**:  
  Existe una **relación significativa** entre los niveles de satisfacción y la rotación. Sin embargo, debido a la advertencia técnica, se recomienda **interpretar con precaución**.

---

### 3. Comparación de salario según rotación

Se aplicó una prueba t de Student para comparar los salarios de empleados que se fueron y los que permanecen.

- **Resultado**:  
  `t = 6.22`, gl ≈ 433, **p-value = 1.16e-09**  
  Promedio sin rotación: **$121,357**  
  Promedio con rotación: **$82,262**  
  Intervalo de confianza (95%): **[$26,745 ; $51,446]**

- **Interpretación**:  
  La diferencia de salario entre grupos es **estadísticamente significativa**. Los empleados que permanecen en la empresa ganan en promedio **$39,000 más** que quienes renuncian, lo que sugiere que el **salario influye en la retención**.

---

### 4. Comparación de antigüedad según rotación (`YearsAtCompany`)

Se compararon los años en la empresa entre ambos grupos utilizando una prueba t de Welch.

- **Resultado**:  
  `t = 18.56`, gl ≈ 387, **p-value < 2.2e-16**  
  Promedio sin rotación: **5.82 años**  
  Promedio con rotación: **2.43 años**  
  Intervalo de confianza (95%): **[3.04 ; 3.76 años]**

- **Interpretación**:  
  Los empleados que permanecen en la empresa tienen en promedio **más del doble de antigüedad** que aquellos que renuncian. Esto indica que **los empleados nuevos son más propensos a abandonar la empresa**.

---

### Conclusión general

Los resultados indican que existen relaciones significativas entre la rotación de personal y variables como:

- **Horas extra**
- **Satisfacción laboral**
- **Salario**
- **Antigüedad**

Particularmente, los empleados con **menor antigüedad**, **menor salario**, **baja satisfacción**, y que **realizan horas extra** presentan una **mayor propensión a dejar la empresa**.

Este análisis permite identificar focos de atención para diseñar políticas de **retención más efectivas**.





## Análisis de Regresión Logística sobre Rotación de Personal

Se construyó un modelo de regresión logística para predecir la probabilidad de atriccion (`Attrition`) en función de las siguientes variables:

- Satisfacción promedio en el trabajo (`avg_JobSatisfaction`)
- Realización de horas extra (`OverTime`)
- Salario (`Salary`)
- Años en la empresa (`YearsAtCompany`)

---

### Resultados del modelo

| Variable              | Coeficiente (Estimate) | Error Estándar | Valor z | Valor p    | Significancia |
|-----------------------|-----------------------:|---------------:|--------:|-----------:|--------------|
| (Intercepto)          |                 0.398  |          0.391 |   1.017 |    0.309   | No significativo |
| avg_JobSatisfaction   |                -0.0055 |          0.102 |  -0.054 |    0.957   | No significativo |
| OverTime (Sí)         |                 1.394  |          0.178 |   7.841 | < 0.0001   | *** Muy significativo |
| Salary                |               -0.000004|          0.000 |  -4.266 | < 0.0001   | *** Muy significativo |
| YearsAtCompany        |                -0.503  |          0.040 | -12.675 | < 0.0001   | *** Muy significativo |

---

### Interpretación

- **Horas extra (`OverTime`)**:  
  Los empleados que realizan horas extra tienen una probabilidad significativamente mayor de renunciar que quienes no lo hacen.

- **Salario (`Salary`)**:  
  A mayor salario, menor es la probabilidad de rotación, lo que sugiere que un mejor salario actúa como factor de retención.

- **Años en la empresa (`YearsAtCompany`)**:  
  Empleados con más antigüedad muestran menor propensión a renunciar, indicando que la permanencia reduce la rotación.

- **Satisfacción laboral promedio (`avg_JobSatisfaction`)**:  
  No se encontró un efecto estadísticamente significativo sobre la rotación, una vez controladas las demás variables.

---

### Conclusión

El modelo muestra que para entender y predecir la rotación del personal es fundamental considerar las horas extra, el salario y la antigüedad. Estos factores influyen significativamente en la probabilidad de que un empleado deje la empresa. Por lo tanto, las estrategias de retención deberían enfocarse en manejar estos aspectos para reducir la rotación.




## Relación entre Salario y Permanencia en la Empresa


### Interpretación

- **Tendencia general**: La pendiente de la línea de regresión es **positiva**, lo que sugiere que, en promedio los empleados con **mayores salarios tienden a permanecer más tiempo** en la empresa.
  
- **Magnitud de la relación**: Aunque la tendencia es ascendente, la **relación parece ser débil**. Esto se evidencia por una amplia dispersión de puntos a lo largo del eje Y (años en la empresa) para cada nivel salarial y una banda de confianza relativamente ancha, lo que indica que hay **incertidumbre** en la estimación de la tendencia.

- **Variabilidad**: Hay empleados con **altos niveles salariales y poca antigüedad**, así como empleados con **salarios bajos y mucha antigüedad**. Esto indica que **otros factores distintos al salario también influyen** en la permanencia laboral.

### Conclusiones

- Existe una **relación positiva leve** entre salario y permanencia en la empresa, pero no es una regla general.
- **El salario por sí solo no explica la duración del empleo**.

## Predicción de Riesgo de Renuncia de Empleados

### Sugerencia


Para predecir si un empleado está en riesgo de renunciar, sugeriría un **modelo de clasificación**, como:

- **Árboles de decisión** o **Random Forest**: capturan relaciones no lineales.


